<!DOCTYPE html>
<html>
<head>
    <title>Freight Cost Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body { margin:0; font-family: Arial; }
        #map { height: 100vh; width: 100%; }
        #panel {
            position: absolute; top:70px; left:10px; /* ✅ moved down to avoid zoom control overlap */
            background: white; padding: 10px; z-index: 1000;
            width: 280px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        #panel select, #panel input, #panel button { width: 100%; margin-bottom: 8px; padding: 6px; }
        #costs { font-size: 14px; }
    </style>
</head>
<body>
    <div id="panel">
        <h3>Freight Cost Tool</h3>

        <label>FOB:</label>
        <select id="fob">
            {% for f in fobs %}
            <option value="{{ f }}">{{ f }}</option>
            {% endfor %}
        </select>

        <h4>Known Quoted Destinations:</h4>
        <select id="known_destination">
            <option value="">-- Select if known --</option>
            {% for d in destinations %}
            <option value="{{ d }}">{{ d }}</option>
            {% endfor %}
        </select>

        <h4>Unknown Destination (Type to Estimate):</h4>
        <input type="text" id="unknown_destination" placeholder="Enter new city..." />

        <button onclick="calculateRoute()">Calculate</button>
        <div id="costs"></div>
    </div>

    <div id="map"></div>

<script>
const map = L.map('map').setView([31, -95], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let routeLine;

async function geocode(query) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
    const res = await fetch(url);
    const data = await res.json();
    return data.length ? {lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon)} : null;
}

async function calculateRoute() {
    const fob = document.getElementById("fob").value;
    const knownDest = document.getElementById("known_destination").value;
    const unknownDest = document.getElementById("unknown_destination").value;

    let destination_name = knownDest || unknownDest;
    if (!destination_name) {
        alert("Please select a known destination or enter an unknown destination.");
        return;
    }

    let destCoords;
    if (knownDest) {
        // ✅ Known destination → no OSRM, send dummy coords
        destCoords = {lat: 0, lon: 0};
    } else {
        // ✅ Unknown destination → geocode
        destCoords = await geocode(unknownDest);
        if (!destCoords) {
            alert("Destination not found.");
            return;
        }
    }

    const response = await axios.post("/route", {
        fob: fob,
        destination_name: destination_name,
        dest_lat: destCoords.lat,
        dest_lon: destCoords.lon
    });

    const data = response.data;
    if (routeLine) map.removeLayer(routeLine);

    routeLine = L.geoJSON(data.geometry).addTo(map);
    map.fitBounds(routeLine.getBounds());

    const c = data.costs;
    let html = `<b>Distance:</b> ${data.distance_km.toFixed(2)} km<br>`;

    if (c.linehaul !== undefined) {
        html += `<span style="color:green;font-weight:bold;">(Quoted Route)</span><br>`;
        html += `
            <b>Linehaul:</b> $${c.linehaul}<br>
            <b>Fuel:</b> $${c.fuel}<br>
            <b>Tank Wash:</b> $${c.tank_wash}<br>
            <b>Other:</b> $${c.other}<br>
        `;
    } else {
        html += `<span style="color:orange;font-weight:bold;">(Estimate)</span><br>`;
    }

    html += `<b>Total:</b> <strong>$${c.total}</strong>`;
    document.getElementById("costs").innerHTML = html;
}
</script>
</body>
</html>
